#!/usr/bin/env node

/**
 * üßπ SCRIPT DE LIMPIEZA Y OPTIMIZACI√ìN COMPLETA DEL PROYECTO - 2025
 * 
 * Este script identifica y elimina archivos duplicados, temporales y no utilizados
 * para optimizar y simplificar la estructura del proyecto.
 */

const fs = require('fs')
const path = require('path')

// üéØ CONFIGURACI√ìN DE LIMPIEZA
const CLEANUP_CONFIG = {
  // Archivos y directorios a eliminar
  filesToDelete: [],
  
  // Reportes temporales de documentaci√≥n
  tempDocuments: [
    'OPTIMIZACION_COMPLETA_EXITOSA_2025.md',
    'CLEANUP_OPTIMIZATION_COMPLETE_2025.md', 
    'RESUMEN_SOLUCION_HIDRATACION_2025.md',
    'RESUMEN_CONVERSACION_COMPLETA_2025.md',
    'SOLUCION_ERRORES_HIDRATACION_SSR_2025.md',
    'SOLUCION_LAG_VIDEOS_2025.md',
    'CORRECCION_LOGGER_IMPORTS_2025.md',
    'MEJORAS_UX_UI_SENIOR_2025.md',
    'ANALISIS_ARQUITECTURA_2025.md',
    'SOLUCION_VIDEOS_MOBILE_2025.md',
    'AUDITORIA_MULTIMEDIA_COMPLETA_2025.md',
    'AUDIT_REPORT_2025.md',
    'OPTIMIZATION_REPORT_2025.md',
    'FINAL_OPTIMIZATION_REPORT_2025.md',
    'DEPLOYMENT_SUMMARY_2025.md',
    'SOLUCION_COMPLETA_SSR_2025.md',
    'SOLUCION_COMPLETA_VIDEO_SYSTEM_2025.md',
    'RESTAURACION_HOME_COMPLETA_2025.md',
    'BUGS_VIDEO_SOLUCIONADOS_2025.md',
    'WORKBOX_FIXES_2025.md',
    'SOLUCION_ACCESIBILIDAD_LIGHTHOUSE_2025.md',
    'CORRECCION_PROPORCIONES_VIDEOS.md',
    'docs/PERFORMANCE_AUDIT_2025.md',
    'docs/DESIGN_SYSTEM_AUDIT_2025.md'
  ],
  
  // Scripts de testing temporales
  tempScripts: [
    'scripts/test-mobile-video-fix-2025.js',
    'scripts/test-ssr-hydration-fixes-2025.js', 
    'scripts/test-complete-video-system-2025.js',
    'scripts/test-video-performance-fix.js',
    'scripts/lighthouse-test-performance.js',
    'scripts/lighthouse-optimizations-2025.js',
    'scripts/run-optimization-complete.js',
    'scripts/optimize-multimedia-2025.js',
    'scripts/test-optimization.js',
    'scripts/verify-optimization-setup.js',
    'scripts/setup-optimization-deps.sh',
    'scripts/fix-typography-props.js',
    'scripts/check-security-status.js',
    'scripts/unify-index-pages-2025.js',
    'scripts/careful-typescript-cleanup-2025.js',
    'scripts/final-typescript-cleanup-2025.js',
    'scripts/cleanup-markdown-2025.js',
    'scripts/auto-cleanup-2025.js',
    'scripts/cleanup-optimization-2025.js',
    'scripts/complete-audit-2025.js',
    'scripts/validate-workbox-fixes.js',
    'scripts/test-ipb-gallery.js',
    'scripts/check-false-positives.js',
    'scripts/security-audit.js',
    'scripts/test-direct-navigation.js',
    'scripts/test-performance.js'
  ],
  
  // Componentes duplicados (mantener solo el que se usa)
  duplicateComponents: [
    'src/components/optimized-video.tsx',        // Eliminar - se usa OptimizedVideoPerformance
    'src/components/OptimizedVideo.tsx',         // Eliminar - se usa OptimizedVideoPerformance
    'src/components/layout.tsx',                 // Eliminar - est√° vac√≠o, se usa layout-2025
    'src/components/grid-item.tsx',              // Eliminar - est√° vac√≠o
    'src/components/ui-components-2025.tsx',     // Evaluar si se puede consolidar
    'src/components/unified-components-2025.tsx', // Evaluar si se puede consolidar
    'src/components/ux-optimizations-2025.tsx'   // Evaluar si se puede consolidar
  ],
  
  // Archivos de reportes JSON temporales
  tempReports: [
    'complete-video-system-report.json',
    'compression-config.json',
    'lighthouse-report.json',
    'performance-optimization-report.json',
    'video-performance-test-report.json',
    'video-reload-fix-report.json',
    'ux-improvements-validation-report.json'
  ],
  
  // Archivos de backup
  backupFiles: [
    'index-old-backup.tsx.bak',
    'src/images/avatar.jpg.backup',
    'src/images/instagram.jpg.backup',
    'static/images/blog/pentest-2024-hero.jpg.backup',
    'static/images/blog/pentest-2024-hero.jpg.temp.jpg'
  ]
}

console.log('üßπ Iniciando limpieza y optimizaci√≥n completa del proyecto...\n')

// üìä Funci√≥n para analizar tama√±o antes de la limpieza
function analyzeProjectSize() {
  console.log('üìä Analizando tama√±o actual del proyecto...')
  
  try {
    const totalFiles = execSync('find . -type f | wc -l', { encoding: 'utf8' }).trim()
    const totalSize = execSync('du -sh . | cut -f1', { encoding: 'utf8' }).trim()
    const mdFiles = execSync('find . -name "*.md" | wc -l', { encoding: 'utf8' }).trim()
    const jsFiles = execSync('find . -name "*.js" | wc -l', { encoding: 'utf8' }).trim()
    const tsxFiles = execSync('find . -name "*.tsx" | wc -l', { encoding: 'utf8' }).trim()
    
    console.log(`   üìÅ Total de archivos: ${totalFiles}`)
    console.log(`   üíæ Tama√±o total: ${totalSize}`)
    console.log(`   üìù Archivos MD: ${mdFiles}`)
    console.log(`   üîß Archivos JS: ${jsFiles}`)
    console.log(`   ‚öõÔ∏è  Archivos TSX: ${tsxFiles}`)
    
    return {
      totalFiles: parseInt(totalFiles),
      totalSize,
      mdFiles: parseInt(mdFiles),
      jsFiles: parseInt(jsFiles),
      tsxFiles: parseInt(tsxFiles)
    }
  } catch (error) {
    console.error('‚ùå Error analizando tama√±o:', error.message)
    return null
  }
}

// üóëÔ∏è Funci√≥n para eliminar archivos de forma segura
function safeDelete(filePath) {
  try {
    if (fs.existsSync(filePath)) {
      const stats = fs.statSync(filePath)
      if (stats.isDirectory()) {
        fs.rmSync(filePath, { recursive: true, force: true })
        console.log(`   üìÅ Eliminado directorio: ${filePath}`)
      } else {
        fs.unlinkSync(filePath)
        console.log(`   üóëÔ∏è  Eliminado archivo: ${filePath}`)
      }
      return true
    } else {
      console.log(`   ‚ö†Ô∏è  No existe: ${filePath}`)
      return false
    }
  } catch (error) {
    console.error(`   ‚ùå Error eliminando ${filePath}:`, error.message)
    return false
  }
}

// üìù Funci√≥n para limpiar documentaci√≥n temporal
function cleanTempDocuments() {
  console.log('\nüìù Limpiando documentaci√≥n temporal...')
  
  let deleted = 0
  CLEANUP_CONFIG.tempDocuments.forEach(doc => {
    if (safeDelete(doc)) {
      deleted++
    }
  })
  
  console.log(`‚úÖ Eliminados ${deleted} documentos temporales`)
  return deleted
}

// üß™ Funci√≥n para limpiar scripts temporales
function cleanTempScripts() {
  console.log('\nüß™ Limpiando scripts temporales...')
  
  let deleted = 0
  CLEANUP_CONFIG.tempScripts.forEach(script => {
    if (safeDelete(script)) {
      deleted++
    }
  })
  
  console.log(`‚úÖ Eliminados ${deleted} scripts temporales`)
  return deleted
}

// ‚öõÔ∏è Funci√≥n para limpiar componentes duplicados
function cleanDuplicateComponents() {
  console.log('\n‚öõÔ∏è Limpiando componentes duplicados...')
  
  let deleted = 0
  CLEANUP_CONFIG.duplicateComponents.forEach(component => {
    if (safeDelete(component)) {
      deleted++
    }
  })
  
  console.log(`‚úÖ Eliminados ${deleted} componentes duplicados`)
  return deleted
}

// üìä Funci√≥n para limpiar reportes JSON temporales
function cleanTempReports() {
  console.log('\nüìä Limpiando reportes JSON temporales...')
  
  let deleted = 0
  CLEANUP_CONFIG.tempReports.forEach(report => {
    if (safeDelete(report)) {
      deleted++
    }
  })
  
  console.log(`‚úÖ Eliminados ${deleted} reportes temporales`)
  return deleted
}

// üíæ Funci√≥n para limpiar archivos de backup
function cleanBackupFiles() {
  console.log('\nüíæ Limpiando archivos de backup...')
  
  let deleted = 0
  CLEANUP_CONFIG.backupFiles.forEach(backup => {
    if (safeDelete(backup)) {
      deleted++
    }
  })
  
  console.log(`‚úÖ Eliminados ${deleted} archivos de backup`)
  return deleted
}

// üéØ Funci√≥n para optimizar imports y dependencias
function optimizeImports() {
  console.log('\nüéØ Optimizando imports...')
  
  // Buscar imports no utilizados o incorrectos
  const componentsToCheck = [
    'src/components/optimized-video.tsx',
    'src/components/OptimizedVideo.tsx',
    'src/components/layout.tsx'
  ]
  
  let fixed = 0
  
  // Buscar archivos que importen los componentes eliminados
  try {
    const execSync = require('child_process').execSync
    
    // Buscar imports de optimized-video
    const grepResult = execSync('grep -r "from.*optimized-video" src/ || true', { encoding: 'utf8' })
    if (grepResult.trim()) {
      console.log('   ‚ö†Ô∏è  Encontrados imports que necesitan actualizaci√≥n:')
      console.log(grepResult.trim())
    }
    
    // Buscar imports de layout.tsx
    const layoutImports = execSync('grep -r "from.*layout\\.tsx" src/ || true', { encoding: 'utf8' })
    if (layoutImports.trim()) {
      console.log('   ‚ö†Ô∏è  Encontrados imports de layout.tsx que necesitan actualizaci√≥n:')
      console.log(layoutImports.trim())
    }
    
  } catch (error) {
    console.error('   ‚ùå Error verificando imports:', error.message)
  }
  
  console.log(`‚úÖ Verificaci√≥n de imports completada`)
  return fixed
}

// üìà Funci√≥n para generar reporte final
function generateCleanupReport(sizeBefore, deletedCounts) {
  console.log('\n' + '='.repeat(60))
  console.log('üìä REPORTE DE LIMPIEZA Y OPTIMIZACI√ìN')
  console.log('='.repeat(60))
  
  const totalDeleted = Object.values(deletedCounts).reduce((a, b) => a + b, 0)
  
  console.log(`\nüìù ARCHIVOS ELIMINADOS:`)
  console.log(`   ‚Ä¢ Documentos temporales: ${deletedCounts.docs}`)
  console.log(`   ‚Ä¢ Scripts temporales: ${deletedCounts.scripts}`)
  console.log(`   ‚Ä¢ Componentes duplicados: ${deletedCounts.components}`)
  console.log(`   ‚Ä¢ Reportes JSON: ${deletedCounts.reports}`)
  console.log(`   ‚Ä¢ Archivos backup: ${deletedCounts.backups}`)
  console.log(`   üìä TOTAL ELIMINADO: ${totalDeleted} archivos`)
  
  // Analizar tama√±o despu√©s
  const sizeAfter = analyzeProjectSize()
  
  if (sizeBefore && sizeAfter) {
    const filesDiff = sizeBefore.totalFiles - sizeAfter.totalFiles
    const mdFilesDiff = sizeBefore.mdFiles - sizeAfter.mdFiles
    
    console.log(`\nüìà IMPACTO DE LA LIMPIEZA:`)
    console.log(`   üìÅ Archivos antes: ${sizeBefore.totalFiles}`)
    console.log(`   üìÅ Archivos despu√©s: ${sizeAfter.totalFiles}`)
    console.log(`   üìâ Reducci√≥n: ${filesDiff} archivos (${((filesDiff / sizeBefore.totalFiles) * 100).toFixed(1)}%)`)
    console.log(`   üìù MD antes: ${sizeBefore.mdFiles}`)
    console.log(`   üìù MD despu√©s: ${sizeAfter.mdFiles}`)
    console.log(`   üìâ MD reducidos: ${mdFilesDiff} archivos`)
  }
  
  console.log(`\n‚úÖ PROYECTO OPTIMIZADO EXITOSAMENTE`)
  console.log(`üéØ El proyecto ahora est√° m√°s limpio y organizado`)
  console.log(`üöÄ Rendimiento mejorado con menos archivos`)
  
  // Crear resumen para el usuario
  const summaryPath = './CLEANUP_SUMMARY_FINAL.md'
  const summaryContent = `# üßπ Resumen de Limpieza y Optimizaci√≥n

## ‚úÖ Limpieza Completada

**Total de archivos eliminados:** ${totalDeleted}

### Categor√≠as eliminadas:
- **${deletedCounts.docs}** documentos temporales
- **${deletedCounts.scripts}** scripts de testing
- **${deletedCounts.components}** componentes duplicados  
- **${deletedCounts.reports}** reportes JSON temporales
- **${deletedCounts.backups}** archivos de backup

### Componentes mantenidos:
- ‚úÖ \`OptimizedVideoPerformance\` (componente principal de video)
- ‚úÖ \`layout-2025.tsx\` (layout principal)
- ‚úÖ Componentes core funcionales

## üéØ Pr√≥ximos pasos:
1. Verificar que el proyecto funciona correctamente
2. Hacer commit de los cambios
3. Deploy a producci√≥n

**Fecha:** ${new Date().toLocaleDateString('es-ES')}
`
  
  try {
    fs.writeFileSync(summaryPath, summaryContent)
    console.log(`\nüìÑ Resumen guardado en: ${summaryPath}`)
  } catch (error) {
    console.error('‚ùå Error guardando resumen:', error.message)
  }
}

// üöÄ Funci√≥n principal
function main() {
  console.log('üßπ LIMPIEZA Y OPTIMIZACI√ìN COMPLETA DEL PROYECTO')
  console.log('=' .repeat(50))
  
  // Analizar tama√±o inicial
  const sizeBefore = analyzeProjectSize()
  
  // Ejecutar limpiezas
  const deletedCounts = {
    docs: cleanTempDocuments(),
    scripts: cleanTempScripts(), 
    components: cleanDuplicateComponents(),
    reports: cleanTempReports(),
    backups: cleanBackupFiles()
  }
  
  // Optimizar imports
  optimizeImports()
  
  // Generar reporte
  generateCleanupReport(sizeBefore, deletedCounts)
}

// A√±adir require para execSync
const { execSync } = require('child_process')

// Ejecutar si es llamado directamente
if (require.main === module) {
  main()
}

module.exports = { main } 